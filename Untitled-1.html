<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard TechTrends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        header h1 {
            margin: 0;
            font-size: 28px;
        }
        
        header p {
            margin: 5px 0 0;
            opacity: 0.8;
        }
        
        .file-input-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .file-input-container input[type="file"] {
            margin: 10px 0;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            margin-top: 0;
            color: var(--dark-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .summary-card h3 {
            margin: 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--dark-color);
        }
        
        .summary-card .trend {
            font-size: 12px;
            color: var(--secondary-color);
        }
        
        .summary-card .trend.negative {
            color: var(--accent-color);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: var(--accent-color);
            background-color: #ffeaea;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Dashboard TechTrends</h1>
            <p>Análisis de ventas y comportamiento del cliente</p>
        </div>
    </header>
    
    <div class="container">
        <div class="file-input-container" id="file-input-container">
            <h3>Carga de los archivos de datos</h3>
            <p>Selecciona el archivo CSV con los datos de ventas:</p>
            <input type="file" id="csv-file" accept=".csv" />
            <p><small>Nota: Esta opción es necesaria cuando el archivo se abre localmente.</small></p>
        </div>
        
        <div class="loading" id="loading" style="display: none;">
            <p>Procesando datos del archivo CSV...</p>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div class="summary-cards" id="summary-cards" style="display: none;">
            <div class="summary-card">
                <h3>Ventas Totales</h3>
                <div class="value" id="total-sales">$0</div>
            </div>
            <div class="summary-card">
                <h3>Productos Vendidos</h3>
                <div class="value" id="total-products">0</div>
            </div>
            <div class="summary-card">
                <h3>Transacciones</h3>
                <div class="value" id="total-transactions">0</div>
            </div>
            <div class="summary-card">
                <h3>Países</h3>
                <div class="value" id="total-countries">0</div>
            </div>
        </div>
        
        <div class="dashboard-grid" id="dashboard-grid" style="display: none;">
            <div class="card">
                <h2>Ventas Mensuales</h2>
                <div class="chart-container">
                    <canvas id="monthlySalesChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>Top 5 Productos Más Vendidos</h2>
                <div class="chart-container">
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>Métodos de Pago</h2>
                <div class="chart-container">
                    <canvas id="paymentMethodsChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>Ventas por Categoría</h2>
                <div class="chart-container">
                    <canvas id="salesByCategoryChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>Ventas por País</h2>
                <div class="chart-container">
                    <canvas id="salesByCountryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>Dashboard TechTrends - Generado con datos de ventas 2024</p>
        </div>
    </footer>

    <script>
        // Función para leer archivo CSV usando FileReader
        function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                
                reader.onerror = function(e) {
                    reject(new Error('Error al leer el archivo'));
                };
                
                reader.readAsText(file);
            });
        }

        // Función para procesar los datos del CSV
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                throw new Error('No hay datos en el archivo CSV');
            }
            
            // Limpiar los encabezados de posibles caracteres extraños
            const headers = lines[0].split(',').map(header => 
                header.trim().replace(/[\r\n"]/g, '')
            );
            
            const data = [];
            
            console.log('Encabezados encontrados:', headers);
            
            for (let i = 1; i < lines.length; i++) {
                // Limpiar la línea de posibles caracteres extraños
                const cleanLine = lines[i].trim().replace(/[\r"]/g, '');
                const values = cleanLine.split(',');
                
                if (values.length === headers.length) {
                    const obj = {};
                    for (let j = 0; j < headers.length; j++) {
                        // Limpiar cada valor
                        obj[headers[j]] = values[j] ? values[j].trim() : '';
                    }
                    data.push(obj);
                } else {
                    console.warn(`Línea ${i + 1} ignorada: número de columnas no coincide. Esperadas: ${headers.length}, Encontradas: ${values.length}`, values);
                }
            }
            
            console.log(`Datos procesados: ${data.length} registros`);
            console.log('Primer registro:', data[0]);
            return data;
        }

        // Calcular métricas para las tarjetas (grafico)
        function calculateSummaryMetrics(data) {
            const totalSales = data.reduce((sum, item) => sum + parseFloat(item.Total_Venta || 0), 0);
            const totalProducts = data.reduce((sum, item) => sum + parseInt(item.Cantidad || 0), 0);
            const totalTransactions = data.length;
            const countries = [...new Set(data.map(item => item.Pais))].length;
            
            return {
                totalSales,
                totalProducts,
                totalTransactions,
                countries
            };
        }
        
        // Actualizar las tarjetas de resumen (grafico)
        function updateSummaryCards(metrics) {
            document.getElementById('total-sales').textContent = `$${metrics.totalSales.toFixed(2)}`;
            document.getElementById('total-products').textContent = metrics.totalProducts;
            document.getElementById('total-transactions').textContent = metrics.totalTransactions;
            document.getElementById('total-countries').textContent = metrics.countries;
        }
        
        // Calculo ventas mensuales
        function calculateMonthlySales(data) {
            const monthlySales = {};
            
            data.forEach(item => {
                const date = new Date(item.Fecha);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthlySales[monthYear]) {
                    monthlySales[monthYear] = 0;
                }
                
                monthlySales[monthYear] += parseFloat(item.Total_Venta || 0);
            });
            
            // Ordenar por fecha
            const sortedMonths = Object.keys(monthlySales).sort();
            const salesByMonth = sortedMonths.map(month => monthlySales[month]);
            
            return {
                labels: sortedMonths,
                data: salesByMonth
            };
        }
        
        // Calculo del top 5 productos mas vendidos
        function calculateTopProducts(data) {
            const productSales = {};
            
            data.forEach(item => {
                const productName = item.Nombre_Producto;
                const total = parseFloat(item.Total_Venta || 0);
                
                if (!productSales[productName]) {
                    productSales[productName] = 0;
                }
                
                productSales[productName] += total;
            });
            
            // Ordenar productos por ventas totales (descendente)
            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            return {
                labels: sortedProducts.map(item => item[0]),
                data: sortedProducts.map(item => item[1])
            };
        }
        
        // Calculo distribución de métodos de pago
        function calculatePaymentMethods(data) {
            const paymentMethods = {};
            
            data.forEach(item => {
                // Usar diferentes nombres posibles para el campo de metodo de pago
                const method = item.Metodo_Pago || item.MetodoPago || item['Método de Pago'] || item.metodo_pago;
                
                if (method && method.trim() !== '') {
                    const cleanMethod = method.trim();
                    if (!paymentMethods[cleanMethod]) {
                        paymentMethods[cleanMethod] = 0;
                    }
                    paymentMethods[cleanMethod] += 1;
                }
            });
            
            console.log('Métodos de pago encontrados:', paymentMethods);
            
            return {
                labels: Object.keys(paymentMethods),
                data: Object.values(paymentMethods)
            };
        }
        
        // Calculo de ventas por categoría
        function calculateSalesByCategory(data) {
            const categorySales = {};
            
            data.forEach(item => {
                const category = item.Categoria;
                const total = parseFloat(item.Total_Venta || 0);
                
                if (!categorySales[category]) {
                    categorySales[category] = 0;
                }
                
                categorySales[category] += total;
            });
            
            return {
                labels: Object.keys(categorySales),
                data: Object.values(categorySales)
            };
        }
        
        // Calculo de ventas por pais
        function calculateSalesByCountry(data) {
            const countrySales = {};
            
            data.forEach(item => {
                const country = item.Pais;
                const total = parseFloat(item.Total_Venta || 0);
                
                if (!countrySales[country]) {
                    countrySales[country] = 0;
                }
                
                countrySales[country] += total;
            });
            
            return {
                labels: Object.keys(countrySales),
                data: Object.values(countrySales)
            };
        }
        
        // Inicializar gráficos
        function initializeCharts(salesData) {
            const monthlySales = calculateMonthlySales(salesData);
            const topProducts = calculateTopProducts(salesData);
            const paymentMethods = calculatePaymentMethods(salesData);
            const salesByCategory = calculateSalesByCategory(salesData);
            const salesByCountry = calculateSalesByCountry(salesData);
            
            // Grafico de ventas mensuales
            new Chart(document.getElementById('monthlySalesChart'), {
                type: 'line',
                data: {
                    labels: monthlySales.labels,
                    datasets: [{
                        label: 'Ventas Mensuales',
                        data: monthlySales.data,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Ventas: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // Grafico de top productos
            new Chart(document.getElementById('topProductsChart'), {
                type: 'bar',
                data: {
                    labels: topProducts.labels,
                    datasets: [{
                        label: 'Ventas Totales',
                        data: topProducts.data,
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(230, 126, 34, 0.7)'
                        ],
                        borderColor: [
                            'rgb(52, 152, 219)',
                            'rgb(46, 204, 113)',
                            'rgb(155, 89, 182)',
                            'rgb(241, 196, 15)',
                            'rgb(230, 126, 34)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Ventas: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // Grafico de métodos de pago
            new Chart(document.getElementById('paymentMethodsChart'), {
                type: 'pie',
                data: {
                    labels: paymentMethods.labels,
                    datasets: [{
                        data: paymentMethods.data,
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(230, 126, 34, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ],
                        borderColor: [
                            'rgb(52, 152, 219)',
                            'rgb(46, 204, 113)',
                            'rgb(155, 89, 182)',
                            'rgb(241, 196, 15)',
                            'rgb(230, 126, 34)',
                            'rgb(231, 76, 60)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} transacciones (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Grafico de ventas por categoria
            new Chart(document.getElementById('salesByCategoryChart'), {
                type: 'doughnut',
                data: {
                    labels: salesByCategory.labels,
                    datasets: [{
                        data: salesByCategory.data,
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)'
                        ],
                        borderColor: [
                            'rgb(52, 152, 219)',
                            'rgb(46, 204, 113)',
                            'rgb(155, 89, 182)',
                            'rgb(241, 196, 15)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Grafico de ventas por pais
            new Chart(document.getElementById('salesByCountryChart'), {
                type: 'bar',
                data: {
                    labels: salesByCountry.labels,
                    datasets: [{
                        label: 'Ventas por País',
                        data: salesByCountry.data,
                        backgroundColor: 'rgba(230, 126, 34, 0.7)',
                        borderColor: 'rgb(230, 126, 34)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Ventas: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Procesamiento del archivo csv seleccionado
        async function processCSVFile(file) {
            try {
                document.getElementById('file-input-container').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error-message').style.display = 'none';
                
                const csvText = await readCSVFile(file);
                const salesData = parseCSV(csvText);
                const metrics = calculateSummaryMetrics(salesData);
                
                // Ocultar mensaje de carga y mostrar contenido
                document.getElementById('loading').style.display = 'none';
                document.getElementById('summary-cards').style.display = 'grid';
                document.getElementById('dashboard-grid').style.display = 'grid';
                
                updateSummaryCards(metrics);
                initializeCharts(salesData);
                
            } catch (error) {
                showError(error.message);
            }
        }
        
        // Configurar el evento para el input de archivo
        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                processCSVFile(file);
            }
        });
    </script>
</body>
</html>
